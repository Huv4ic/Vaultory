# üö® –°–†–û–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–í–ï–ù–¢–ê–†–Ø

## –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∞: "–¢–∞–±–ª–∏—Ü–∞ withdrawal_requests –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" (–Ω–æ —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!)

## –†–µ—à–µ–Ω–∏–µ

### 1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∫–æ–º–∞–Ω–¥—ã –≤ Supabase

–û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã **–ø–æ –æ–¥–Ω–æ–π**:

```sql
-- –ö–æ–º–∞–Ω–¥–∞ 1: –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É user_statistics
CREATE TABLE IF NOT EXISTS user_statistics (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    telegram_id BIGINT UNIQUE NOT NULL,
    cases_opened INTEGER DEFAULT 0,
    items_sold INTEGER DEFAULT 0,
    total_spent DECIMAL(10,2) DEFAULT 0,
    total_earned DECIMAL(10,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

```sql
-- –ö–æ–º–∞–Ω–¥–∞ 2: –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É withdrawal_status
ALTER TABLE user_inventory ADD COLUMN IF NOT EXISTS withdrawal_status TEXT DEFAULT 'available';
```

```sql
-- –ö–æ–º–∞–Ω–¥–∞ 3: –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é initialize_user_statistics
CREATE OR REPLACE FUNCTION initialize_user_statistics(user_telegram_id BIGINT)
RETURNS VOID AS $$
BEGIN
    INSERT INTO user_statistics (telegram_id, cases_opened, items_sold, total_spent, total_earned)
    VALUES (user_telegram_id, 0, 0, 0, 0)
    ON CONFLICT (telegram_id) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

```sql
-- –ö–æ–º–∞–Ω–¥–∞ 4: –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é increment_user_cases_opened
CREATE OR REPLACE FUNCTION increment_user_cases_opened(user_telegram_id BIGINT, cases_count INTEGER DEFAULT 1)
RETURNS VOID AS $$
BEGIN
    INSERT INTO user_statistics (telegram_id, cases_opened, items_sold, total_spent, total_earned)
    VALUES (user_telegram_id, cases_count, 0, 0, 0)
    ON CONFLICT (telegram_id) 
    DO UPDATE SET 
        cases_opened = user_statistics.cases_opened + cases_count,
        updated_at = NOW();
END;
$$ LANGUAGE plpgsql;
```

```sql
-- –ö–æ–º–∞–Ω–¥–∞ 5: –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é increment_user_items_sold
CREATE OR REPLACE FUNCTION increment_user_items_sold(user_telegram_id BIGINT, item_price DECIMAL)
RETURNS VOID AS $$
BEGIN
    INSERT INTO user_statistics (telegram_id, cases_opened, items_sold, total_spent, total_earned)
    VALUES (user_telegram_id, 0, 1, 0, item_price)
    ON CONFLICT (telegram_id) 
    DO UPDATE SET 
        items_sold = user_statistics.items_sold + 1,
        total_earned = user_statistics.total_earned + item_price,
        updated_at = NOW();
END;
$$ LANGUAGE plpgsql;
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
SELECT 'withdrawal_requests' as table_name, COUNT(*) as count FROM withdrawal_requests
UNION ALL
SELECT 'user_statistics' as table_name, COUNT(*) as count FROM user_statistics
UNION ALL
SELECT 'user_inventory' as table_name, COUNT(*) as count FROM user_inventory;
```

```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
SELECT routine_name FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name IN (
    'initialize_user_statistics',
    'increment_user_cases_opened', 
    'increment_user_items_sold'
);
```

### 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –∫–æ–º–∞–Ω–¥:
1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏

## –ï—Å–ª–∏ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞** - —Ç–∞–º –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Supabase Dashboard** - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
3. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–µ–π—Å –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ SQL –∫–æ–º–∞–Ω–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª `minimal-inventory-fix.sql` - —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ Supabase SQL Editor –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ü–µ–ª–∏–∫–æ–º.

## –ö–æ–Ω—Ç–∞–∫—Ç—ã
–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ —Ä–µ—à–∞—é—Ç—Å—è, –ø—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—à–∏–±–æ–∫ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞.
