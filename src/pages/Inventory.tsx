import { useState, useEffect } from 'react';
import { useAuth } from '@/hooks/useAuth';
import { useInventory, InventoryItem } from '@/hooks/useInventory';
import { useCaseStats } from '@/hooks/useCaseStats';
import { useLanguage } from '@/hooks/useLanguage';
import { useNavigate } from 'react-router-dom';
import { useNotification } from '@/hooks/useNotification';
import { useWithdrawalRequests } from '@/hooks/useWithdrawalRequests';
import Notification from '@/components/ui/Notification';
import { 
  Package, 
  Star, 
  DollarSign, 
  Trophy, 
  ArrowLeft,
  Crown,
  Zap,
  TrendingUp
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { supabase } from '../integrations/supabase/client';

interface FavoriteCase {
  case_id: string;
  case_name: string;
  opened_count: number;
  case_image_url?: string;
}

const Inventory = () => {
  const { telegramUser, profile } = useAuth();
  const { items: inventoryItems, getTotalValue, casesOpened, refreshItems, sellItem, withdrawItem, getCasesOpened } = useInventory();

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–ª–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
  const formatNumber = (amount: number): string => {
    return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  };
  const { favoriteCase, caseStats, loading: statsLoading, error: statsError } = useCaseStats();
  const { t } = useLanguage();
  const navigate = useNavigate();
  const { showSuccess, showError, showWarning, notification, hideNotification } = useNotification();
  const { createWithdrawalRequest, loading: withdrawalLoading } = useWithdrawalRequests();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [totalCasesOpened, setTotalCasesOpened] = useState(0);
  const [totalValue, setTotalValue] = useState(0);
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤
  const [displayItems, setDisplayItems] = useState<InventoryItem[]>([]);
  const [showConfirmSell, setShowConfirmSell] = useState(false);
  const [itemToSell, setItemToSell] = useState<InventoryItem | null>(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–≤–æ–¥–∞
  const [showWithdrawModal, setShowWithdrawModal] = useState(false);
  const [showWithdrawSuccess, setShowWithdrawSuccess] = useState(false);
  const [itemToWithdraw, setItemToWithdraw] = useState<InventoryItem | null>(null);
  const [withdrawalForm, setWithdrawalForm] = useState({
    itemName: '',
    telegramUsername: ''
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º displayItems –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  useEffect(() => {
    setDisplayItems(inventoryItems);
  }, []);

  // –û—Ç–ª–∞–¥–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  useEffect(() => {
    console.log('üîç –û—Ç–ª–∞–¥–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', { showWithdrawModal, itemToWithdraw });
    if (showWithdrawModal) {
      console.log('üéØ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–ª–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è!');
    }
  }, [showWithdrawModal, itemToWithdraw]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
  useEffect(() => {
    const loadTotalValue = async () => {
      const value = await getTotalValue();
      setTotalValue(value);
    };
    loadTotalValue();
  }, [getTotalValue, inventoryItems]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–µ–π—Å–æ–≤
  useEffect(() => {
    const loadCasesOpened = async () => {
      const count = await getCasesOpened();
      setTotalCasesOpened(count);
    };
    loadCasesOpened();
  }, [getCasesOpened]);

  useEffect(() => {
    if (!telegramUser) {
      navigate('/auth');
      return;
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    const hasRefreshed = sessionStorage.getItem('inventory_refreshed');
    if (!hasRefreshed) {
      sessionStorage.setItem('inventory_refreshed', 'true');
      
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
      console.log('–û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É');
      refreshItems().catch(console.error);
    }
  }, [telegramUser, navigate, refreshItems]);

  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ inventoryItems
  useEffect(() => {
    setDisplayItems(inventoryItems);
  }, [inventoryItems]);

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
  const isLoading = loading || statsLoading;
  const hasError = error || statsError;

  const getRarityColor = (rarity: string) => {
    switch (rarity) {
      case 'common': return 'text-gray-400';
      case 'uncommon': return 'text-green-400';
      case 'rare': return 'text-blue-400';
      case 'epic': return 'text-purple-400';
      case 'legendary': return 'text-amber-400';
      default: return 'text-gray-400';
    }
  };

  const getRarityBg = (rarity: string) => {
    switch (rarity) {
      case 'common': return 'inventory-rarity-common';
      case 'uncommon': return 'inventory-rarity-common';
      case 'rare': return 'inventory-rarity-rare';
      case 'epic': return 'inventory-rarity-epic';
      case 'legendary': return 'inventory-rarity-legendary';
      default: return 'inventory-rarity-common';
    }
  };

  const handleCancelSell = () => {
    setShowConfirmSell(false);
    setItemToSell(null);
  };

  const handleConfirmSell = async () => {
    if (!itemToSell) return;
    
    try {
      // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –º–∞—Å—Å–∏–≤–µ
      const itemIndex = inventoryItems.findIndex(invItem => invItem.id === itemToSell.id);
      console.log('üîç –ò–Ω–¥–µ–∫—Å –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –º–∞—Å—Å–∏–≤–µ:', itemIndex);
      
      if (itemIndex !== -1) {
        console.log('‚úÖ –ü—Ä–µ–¥–º–µ—Ç –Ω–∞–π–¥–µ–Ω, –≤—ã–∑—ã–≤–∞–µ–º sellItem...');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é sellItem –∏–∑ useInventory
        const sellPrice = await sellItem(itemIndex);
        console.log('üí∞ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–¥–∞–∂–∏:', sellPrice);
        
        if (sellPrice > 0) {
          console.log('‚úÖ –ü—Ä–µ–¥–º–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–¥–∞–Ω –∑–∞:', sellPrice);
          
          // –ë–∞–ª–∞–Ω—Å —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ inventoryService.sellItem
          
          showSuccess(`–ü—Ä–µ–¥–º–µ—Ç "${itemToSell.name}" –ø—Ä–æ–¥–∞–Ω –∑–∞ ${sellPrice.toFixed(2)}‚Ç¥! –î–µ–Ω—å–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –±–∞–ª–∞–Ω—Å.`);
          console.log('–ü—Ä–µ–¥–º–µ—Ç –ø—Ä–æ–¥–∞–Ω:', itemToSell.name, '–∑–∞', sellPrice);
        } else {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –ø—Ä–µ–¥–º–µ—Ç–∞, —Ü–µ–Ω–∞:', sellPrice);
          showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –ø—Ä–µ–¥–º–µ—Ç–∞!');
        }
      } else {
        console.error('‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ!');
        showError('–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ!');
      }
    } catch (error) {
      console.error('‚ùå Error selling item:', error);
      showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –ø—Ä–µ–¥–º–µ—Ç–∞!');
    }
    
    setShowConfirmSell(false);
    setItemToSell(null);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 via-black to-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-amber-400 mx-auto mb-4"></div>
          <p className="text-white text-lg">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è...</p>
        </div>
      </div>
    );
  }

  if (hasError) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 via-black to-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-400 text-6xl mb-4">‚ö†Ô∏è</div>
          <p className="text-red-400 text-lg mb-4">{error}</p>
          <Button onClick={() => window.location.reload()} className="bg-amber-500 hover:bg-amber-600">
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-black relative overflow-hidden">
      {/* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */}
      <div className="absolute inset-0">
        {/* –ü–ª–∞–≤–∞—é—â–∏–µ —á–∞—Å—Ç–∏—Ü—ã */}
        <div className="absolute top-1/4 left-1/4 w-2 h-2 bg-green-400 rounded-full animate-ping opacity-60"></div>
        <div className="absolute top-1/3 right-1/3 w-1 h-1 bg-blue-400 rounded-full opacity-80"></div>
        <div className="absolute bottom-1/4 left-1/3 w-3 h-3 bg-yellow-400 rounded-full animate-bounce opacity-40"></div>
        <div className="absolute top-1/2 right-1/4 w-2 h-2 bg-orange-400 rounded-full animate-ping opacity-70"></div>
        <div className="absolute bottom-1/3 right-1/2 w-1 h-1 bg-red-400 rounded-full opacity-90"></div>
        <div className="absolute top-3/4 left-1/2 w-2 h-2 bg-purple-400 rounded-full animate-bounce opacity-50"></div>
        
        {/* –°–≤–µ—Ç—è—â–∏–µ—Å—è –ª–∏–Ω–∏–∏ */}
        <div className="absolute top-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-green-500/50 to-transparent"></div>
        <div className="absolute bottom-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>
      </div>

      {/* Hero Section */}
      <div className="relative z-10">
        <div className="container mx-auto px-4 py-16 md:py-24 text-center">
          {/* –ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */}
          <div className="mb-8">
            <div className="inline-flex items-center justify-center w-20 h-20 md:w-24 md:h-24 bg-black/80 backdrop-blur-xl rounded-full mb-6 border border-green-500/30 shadow-2xl shadow-green-500/30">
              <Package className="w-10 h-10 md:w-12 md:h-12 text-green-400" />
            </div>
            <h1 className="text-4xl md:text-6xl lg:text-7xl font-black mb-6 text-white text-center">
              –ò–ù–í–ï–ù–¢–ê–†–¨
            </h1>
            <div className="w-32 h-1 bg-green-500 mx-auto rounded-full"></div>
          </div>
          
          {/* –û–ø–∏—Å–∞–Ω–∏–µ */}
          <p className="text-lg md:text-xl lg:text-2xl text-gray-300 mb-12 max-w-4xl mx-auto leading-relaxed">
            –í–∞—à–∞ <span className="text-green-400 font-bold">–∫–æ–ª–ª–µ–∫—Ü–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤</span>! 
            –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ <span className="text-blue-400 font-bold">–ø—Ä–æ–¥–∞–≤–∞—Ç—å</span> –∏ <span className="text-yellow-400 font-bold">–≤—ã–≤–æ–¥–∏—Ç—å</span> –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã.
          </p>
        </div>
      </div>

      {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
      <div className="relative z-20 container mx-auto px-4 pb-12 sm:pb-16 md:pb-20">
        {/* –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" */}
        <div className="mb-8">
          <Button
            onClick={() => navigate(-1)}
            variant="outline"
            className="px-6 py-3 bg-black/80 backdrop-blur-xl border border-green-500/30 text-green-300 hover:text-white transition-all duration-300 shadow-xl shadow-green-500/20 rounded-xl text-sm font-medium hover:scale-105"
          >
            <ArrowLeft className="w-4 h-4 mr-2" />
            –ù–∞–∑–∞–¥
          </Button>
        </div>
        
        {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
          {/* –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å */}
          <div className="group relative">
            <div className="absolute -inset-1 bg-green-500/20 rounded-3xl blur-xl"></div>
            <div className="relative bg-black/90 backdrop-blur-xl rounded-3xl p-8 text-center border border-green-500/30 hover:border-green-400/50 transition-all duration-500 hover:scale-105">
              <div className="mx-auto w-20 h-20 bg-green-500/20 rounded-2xl flex items-center justify-center mb-6 border border-green-500/30 group-hover:rotate-12 transition-all duration-500 shadow-xl shadow-green-500/20">
                <DollarSign className="w-10 h-10 text-green-400" />
              </div>
              <h3 className="text-xl font-bold text-white mb-4">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
              <div className="text-3xl sm:text-4xl font-black text-green-400 inventory-stats-counter mb-2 drop-shadow-lg">
                {formatNumber(parseFloat(totalValue.toFixed(2)))}‚Ç¥
              </div>
              <div className="text-sm text-gray-400">–°—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
            </div>
          </div>

          {/* –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ */}
          <div className="group relative">
            <div className="absolute -inset-1 bg-blue-500/20 rounded-3xl blur-xl"></div>
            <div className="relative bg-black/90 backdrop-blur-xl rounded-3xl p-8 text-center border border-blue-500/30 hover:border-blue-400/50 transition-all duration-500 hover:scale-105">
              <div className="mx-auto w-20 h-20 bg-blue-500/20 rounded-2xl flex items-center justify-center mb-6 border border-blue-500/30 group-hover:rotate-12 transition-all duration-500 shadow-xl shadow-blue-500/20">
                <Package className="w-10 h-10 text-blue-400" />
              </div>
              <h3 className="text-xl font-bold text-white mb-4">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
              <div className="text-3xl sm:text-4xl font-black text-blue-400 mb-2">
                {displayItems.length}
              </div>
              <div className="text-sm text-gray-400">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
            </div>
          </div>

          {/* –õ—é–±–∏–º—ã–π –∫–µ–π—Å */}
          <div className="group relative">
            <div className="absolute -inset-1 bg-yellow-500/20 rounded-3xl blur-xl"></div>
            <div className="relative bg-black/90 backdrop-blur-xl rounded-3xl p-8 text-center border border-yellow-500/30 hover:border-yellow-400/50 transition-all duration-500 hover:scale-105">
              <div className="mx-auto w-20 h-20 bg-yellow-500/20 rounded-2xl flex items-center justify-center mb-6 border border-yellow-500/30 group-hover:rotate-12 transition-all duration-500 shadow-xl shadow-yellow-500/20">
                <Crown className="w-10 h-10 text-yellow-400" />
              </div>
              <h3 className="text-xl font-bold text-white mb-4">–õ—é–±–∏–º—ã–π –∫–µ–π—Å</h3>
              
              {favoriteCase ? (
                <>
                  {/* –§–æ—Ç–æ –∫–µ–π—Å–∞ —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ */}
                  <div className="w-24 h-24 mx-auto mb-4 rounded-2xl overflow-hidden bg-gray-800 border border-yellow-500/30 group-hover:scale-105 transition-transform duration-300">
                    {favoriteCase.case_image_url ? (
                      <img 
                        src={favoriteCase.case_image_url} 
                        alt={favoriteCase.case_name}
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-yellow-400">
                        <Trophy className="w-10 h-10" />
                      </div>
                    )}
                  </div>
                  <div className="text-lg font-bold text-yellow-400 mb-2">{favoriteCase.case_name}</div>
                  <div className="text-sm text-gray-400">–û—Ç–∫—Ä—ã—Ç–æ {favoriteCase.opened_count} —Ä–∞–∑</div>
                </>
              ) : (
                <div className="text-gray-400 font-medium">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
              )}
            </div>
          </div>
        </div>

        {/* –°–µ—Ç–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */}
        <div className="space-y-8">
          {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏ */}
          <div className="text-center">
            <h3 className="text-2xl md:text-3xl font-black text-white mb-4">
              –ü—Ä–µ–¥–º–µ—Ç—ã –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
            </h3>
            <div className="w-24 h-1 bg-blue-500 mx-auto rounded-full mb-4"></div>
            <div className="text-blue-300 font-medium">
              –ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: <span className="text-white font-bold">{displayItems.length}</span>
            </div>
          </div>
          
          {displayItems.length === 0 ? (
            <div className="group relative">
              <div className="absolute -inset-1 bg-gray-500/20 rounded-3xl blur-xl"></div>
              <div className="relative bg-black/90 backdrop-blur-xl rounded-3xl border border-gray-500/30 p-16 text-center hover:border-gray-400/50 transition-all duration-500 hover:scale-105">
                <div className="w-24 h-24 mx-auto mb-6 bg-gray-500/20 rounded-2xl flex items-center justify-center border border-gray-500/30 group-hover:rotate-12 transition-all duration-500 shadow-xl shadow-gray-500/20">
                  <Package className="w-12 h-12 text-gray-400" />
                </div>
                <h4 className="text-2xl font-black text-white mb-3">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</h4>
                <p className="text-gray-400 text-lg mb-6 max-w-md mx-auto leading-relaxed">
                  –û—Ç–∫—Ä–æ–π—Ç–µ –∫–µ–π—Å—ã, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –Ω–∞—á–∞—Ç—å —Å–≤–æ—é –∫–æ–ª–ª–µ–∫—Ü–∏—é!
                </p>
                
                <button
                  onClick={() => navigate('/cases')}
                  className="px-8 py-4 bg-blue-500 hover:bg-blue-600 text-white font-black rounded-2xl transition-all duration-300 hover:scale-105 shadow-xl shadow-blue-500/25"
                >
                  üéÅ –û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å—ã
                </button>
              </div>
            </div>
          ) : (
            <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4">
              {displayItems.map((item, index) => (
                <div
                  key={item.id || Math.random()}
                  className={`inventory-card-3d inventory-item-glow relative overflow-hidden rounded-2xl p-4 ${getRarityBg(item.rarity || 'common')} border-2 shadow-2xl transition-all duration-500 group animate-inventory-slide-in`}
                  style={{animationDelay: `${index * 0.1}s`}}
                >
                  {/* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ */}
                  <div className="relative mb-4">
                    <div className="w-full h-32 rounded-xl overflow-hidden bg-black/30 backdrop-blur-sm border border-white/10 inventory-holographic">
                      {item.image_url || item.image ? (
                        <img 
                          src={item.image_url || item.image} 
                          alt={item.name}
                          className="w-full h-full object-contain group-hover:scale-110 transition-transform duration-500"
                          onError={(e) => {
                            // Fallback –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
                            const target = e.target as HTMLImageElement;
                            target.style.display = 'none';
                            target.nextElementSibling?.classList.remove('hidden');
                          }}
                        />
                      ) : null}
                      
                      {/* Fallback –∏–∫–æ–Ω–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */}
                      <div className={`w-full h-full flex items-center justify-center ${item.image_url || item.image ? 'hidden' : ''}`}>
                        <Package className={`w-16 h-16 ${getRarityColor(item.rarity || 'common')}`} />
                      </div>
                    </div>
                    
                    {/* –ó–Ω–∞—á–æ–∫ —Ä–µ–¥–∫–æ—Å—Ç–∏ */}
                    <div className={`absolute top-2 right-2 px-2 py-0.5 rounded-full text-xs font-bold uppercase backdrop-blur-sm border ${getRarityColor(item.rarity || 'common')} bg-black/50`}>
                      {(item.rarity || 'common').slice(0, 3)}
                    </div>
                  </div>
                  
                  {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–¥–º–µ—Ç–µ */}
                  <div className="space-y-3">
                    {/* –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ */}
                    <div className="text-center">
                      <h4 className={`text-sm font-bold ${getRarityColor(item.rarity || 'common')} mb-1 drop-shadow-lg group-hover:scale-105 transition-transform duration-300 line-clamp-2`}>
                        {item.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç'}
                      </h4>
                      <div className="text-lg font-black text-green-400 mb-1 drop-shadow-lg">
                        {(item.price || 0).toFixed(0)}‚Ç¥
                      </div>
                    </div>
                    
                    {/* –î–µ—Ç–∞–ª–∏ - –∫–æ–º–ø–∞–∫—Ç–Ω–æ */}
                    <div className="bg-black/20 rounded-xl p-2 backdrop-blur-sm border border-white/5">
                      <div className="text-xs text-gray-400 mb-1">
                        <span className="text-white font-medium">{item.case_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                      </div>
                      <div className="text-xs text-gray-500">
                        {item.obtained_at ? new Date(item.obtained_at).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                      </div>
                    </div>
                    
                    {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ */}
                    <div className="flex gap-2">
                      <button
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          
                          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞
                          console.log('üîÑ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–í—ã–≤–µ—Å—Ç–∏" –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞:', item);
                          console.log('üìã –¢–µ–∫—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è:', { showWithdrawModal, itemToWithdraw });
                          
                          setItemToWithdraw(item);
                          setWithdrawalForm({
                            itemName: item.name || '',
                            telegramUsername: ''
                          });
                          setShowWithdrawModal(true);
                          
                          console.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ, –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è');
                          
                          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                          setTimeout(() => {
                            console.log('üìã –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:', { 
                              showWithdrawModal: true, // –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true
                              itemToWithdraw: item 
                            });
                          }, 100);
                        }}
                        className="inventory-button-shine flex-1 px-2 py-2 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white text-xs font-bold rounded-xl transition-all duration-300 hover:scale-105 shadow-lg shadow-blue-500/25"
                      >
                        üì§
                      </button>
                      
                      <button
                        onClick={async () => {
                          // –ü—Ä–æ–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç
                          console.log('üîÑ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–∞—Ç—å" –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞:', item);
                          setItemToSell(item);
                          setShowConfirmSell(true);
                        }}
                        className="inventory-button-shine flex-1 px-2 py-2 bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white text-xs font-bold rounded-xl transition-all duration-300 hover:scale-105 shadow-lg shadow-red-500/25"
                      >
                        üí∞
                      </button>
                    </div>
                  </div>
                  
                  {/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã - —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ */}
                  <div className="absolute top-1 left-1 w-2 h-2 bg-white/10 rounded-full animate-ping"></div>
                  <div className="absolute bottom-1 right-1 w-1.5 h-1.5 bg-white/5 rounded-full animate-pulse"></div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
      
      {/* –ö—Ä–∞—Å–∏–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
      <Notification
        show={notification.show}
        message={notification.message}
        type={notification.type}
        onClose={hideNotification}
        autoHide={notification.autoHide}
        duration={notification.duration}
      />

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏ */}
      {showConfirmSell && itemToSell && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-gray-800 border border-gray-700 rounded-xl p-6 max-w-md w-full">
            <div className="text-center">
              <div className="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <DollarSign className="w-8 h-8 text-yellow-400" />
              </div>
              <h3 className="text-xl font-bold text-white mb-2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏</h3>
              <p className="text-gray-300 mb-4">
                –ü—Ä–æ–¥–∞—Ç—å "{itemToSell.name}" –∑–∞ {itemToSell.price}‚Ç¥?
              </p>
              <p className="text-sm text-gray-400 mb-6">
                –î–µ–Ω—å–≥–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å
              </p>
              
              <div className="flex gap-3">
                <button
                  onClick={handleCancelSell}
                  className="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors"
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
                <button
                  onClick={handleConfirmSell}
                  className="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
                >
                  –ü—Ä–æ–¥–∞—Ç—å
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ */}
      {showWithdrawModal && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-gradient-to-br from-gray-900/95 to-gray-800/95 rounded-2xl p-6 max-w-md w-full border border-blue-500/30 shadow-2xl shadow-blue-500/20">
            <h3 className="text-xl font-bold text-white mb-4 text-center">
              üì§ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ –ø—Ä–µ–¥–º–µ—Ç–∞
            </h3>
            
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–¥–º–µ—Ç–µ */}
            {itemToWithdraw ? (
              <div className="bg-gray-800/50 rounded-xl p-4 mb-4 border border-gray-600/30">
                <div className="flex items-center space-x-3">
                  {itemToWithdraw.image_url || itemToWithdraw.image ? (
                    <img 
                      src={itemToWithdraw.image_url || itemToWithdraw.image} 
                      alt={itemToWithdraw.name}
                      className="w-12 h-12 object-contain rounded-lg"
                    />
                  ) : (
                    <div className="w-12 h-12 bg-gray-700/50 rounded-lg flex items-center justify-center">
                      <Package className="w-6 h-6 text-gray-400" />
                    </div>
                  )}
                  <div>
                    <h4 className="text-white font-semibold">{itemToWithdraw.name}</h4>
                    <p className="text-green-400 text-sm">{itemToWithdraw.price}‚Ç¥</p>
                  </div>
                </div>
              </div>
            ) : (
              <div className="bg-gray-800/50 rounded-xl p-4 mb-4 border border-gray-600/30 text-center">
                <p className="text-gray-400">–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</p>
              </div>
            )}
            
            {/* –§–æ—Ä–º–∞ */}
            <div className="space-y-4">
              <div>
                <label className="block text-gray-300 text-sm font-medium mb-2">
                  –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
                </label>
                <input
                  type="text"
                  value={withdrawalForm.itemName}
                  onChange={(e) => setWithdrawalForm(prev => ({ ...prev, itemName: e.target.value }))}
                  className="w-full px-3 py-2 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"
                />
              </div>
              
              <div>
                <label className="block text-gray-300 text-sm font-medium mb-2">
                  Telegram username
                </label>
                <input
                  type="text"
                  value={withdrawalForm.telegramUsername}
                  onChange={(e) => setWithdrawalForm(prev => ({ ...prev, telegramUsername: e.target.value }))}
                  className="w-full px-3 py-2 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50"
                  placeholder="@username"
                />
                <p className="text-gray-400 text-xs mt-1">–£–∫–∞–∂–∏—Ç–µ –≤–∞—à Telegram –¥–ª—è —Å–≤—è–∑–∏</p>
              </div>
            </div>
            
            {/* –ö–Ω–æ–ø–∫–∏ */}
            <div className="flex gap-3 mt-6">
              <button
                onClick={() => {
                  setShowWithdrawModal(false);
                  setItemToWithdraw(null);
                  setWithdrawalForm({ itemName: '', telegramUsername: '' });
                }}
                className="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors"
                disabled={withdrawalLoading}
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={async () => {
                  if (!profile?.telegram_id || !itemToWithdraw?.id) return;
                  
                  if (!withdrawalForm.itemName.trim() || !withdrawalForm.telegramUsername.trim()) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                  }
                  
                  const success = await createWithdrawalRequest(
                    profile.telegram_id,
                    itemToWithdraw.id,
                    withdrawalForm.itemName.trim(),
                    withdrawalForm.telegramUsername.trim()
                  );
                  
                  if (success) {
                    setShowWithdrawModal(false);
                    setShowWithdrawSuccess(true);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, —á—Ç–æ–±—ã –ø—Ä–µ–¥–º–µ—Ç –∏—Å—á–µ–∑ –∏–∑ —Å–ø–∏—Å–∫–∞
                    await refreshItems();
                  }
                }}
                className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled={withdrawalLoading}
              >
                {withdrawalLoading ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ */}
      {showWithdrawSuccess && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-gradient-to-br from-gray-900/95 to-gray-800/95 rounded-2xl p-6 max-w-md w-full border border-green-500/30 shadow-2xl shadow-green-500/20 text-center">
            <div className="text-6xl mb-4">‚úÖ</div>
            <h3 className="text-xl font-bold text-white mb-4">
              –ó–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω!
            </h3>
            <p className="text-gray-300 mb-6 leading-relaxed">
              –í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ –ø—Ä–µ–¥–º–µ—Ç–∞ –ø—Ä–∏–Ω—è—Ç. –í—ã –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ <strong className="text-green-400">72 —á–∞—Å–æ–≤</strong> —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.
            </p>
            
            <div className="space-y-3">
              <button
                onClick={() => window.open('https://t.me/Vaultory_manager', '_blank')}
                className="w-full px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg transition-all duration-300 hover:scale-105 font-medium"
              >
                üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram
              </button>
              
              <button
                onClick={() => {
                  setShowWithdrawSuccess(false);
                  setItemToWithdraw(null);
                  setWithdrawalForm({ itemName: '', telegramUsername: '' });
                }}
                className="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors"
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Inventory;
